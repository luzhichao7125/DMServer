{"version":3,"file":"srv.js","sources":["../../../.ts-plugin/src/strapi.ts","../../../.ts-plugin/src/plugins/dm-page.plugin/dm-page-stat.ts","../../../.ts-plugin/src/plugins/dm-page.plugin/dm-page.ts","../../../.ts-plugin/src/srv.ts"],"sourcesContent":["export interface IDoc {\r\n  id: number\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\ninterface Log {\r\n  fatal(message?: any, ...optionalParams: any[]): void\r\n  error(message?: any, ...optionalParams: any[]): void\r\n  warn(message?: any, ...optionalParams: any[]): void\r\n  info(message?: any, ...optionalParams: any[]): void\r\n  debug(message?: any, ...optionalParams: any[]): void\r\n}\r\n\r\ninterface CRUD {\r\n  // https://strapi.io/documentation/v3.x/concepts/queries.html#api-reference\r\n  create(collection_data: any): Array<any>\r\n  // _sort filed_name:asc|desc|ASC|DESC\r\n  find(\r\n    query_param:\r\n      | any\r\n      | {\r\n          _sort?: 'filed_name:asc' | 'filed_name:desc'\r\n          _limit: number\r\n          _start: number\r\n        }\r\n  ): Array<IDoc>\r\n  update(query_param: any | { id: number }, collection_data: any): Array<any>\r\n  delete(query_param: any): Array<any>\r\n}\r\nexport const UTIL_public_doc = (doc: any) => {\r\n  let d = JSON.parse(JSON.stringify(doc))\r\n  delete d['created_by']\r\n  delete d['updated_by']\r\n  return d\r\n}\r\nexport interface IStrapi {\r\n  // socket.io\r\n  io?: any\r\n  log: Log\r\n  server?: any\r\n  query(content: string): CRUD\r\n}\r\n\r\ndeclare let strapi: IStrapi\r\nexport const strapi_ = strapi\r\n","import { strapi_, IDoc } from '../../strapi'\r\n\r\nlet strapi = strapi_\r\nconst request = require('request')\r\n\r\nconst post_data = async (url: string, data: any) => {\r\n  await request(\r\n    {\r\n      url,\r\n      method: 'POST',\r\n      json: true,\r\n      headers: {\r\n        'content-type': 'application/json'\r\n      },\r\n      body: data\r\n    },\r\n    function (error: any, response: any, body: any) {\r\n      if (!error && response.statusCode == 200) {\r\n      }\r\n    }\r\n  )\r\n}\r\ninterface Idoc_plugin_conf extends IDoc {\r\n  name: string\r\n  rpc_server_url: string\r\n  stat_from: string\r\n}\r\nexport class DouyinStat {\r\n  init = false\r\n  douyin_pk_conf: any = null\r\n  douyin_pages_loaded = {}\r\n  stat_pk: any = {}\r\n  async boot() {\r\n    strapi_.log.info('douyin stat boot')\r\n    const [entry] = (await strapi\r\n      .query('plugin-conf')\r\n      .find({ name: 'douyin-pk' })) as Array<Idoc_plugin_conf>\r\n\r\n    if (entry) {\r\n      strapi.log.info('dm service index', entry.name)\r\n      this.init_ws_poll(entry['rpc_server_url'])\r\n      this.douyin_pk_conf = entry\r\n      this.stat_pk = {}\r\n\r\n      // strapi.log.info(\"dm-plugin today\", this.today_date);\r\n      // strapi.log.info(\"strapi.services\", strapi.services);\r\n      await this.calc_pk()\r\n    }\r\n  }\r\n  async init_ws_poll(rpc_url: string) {\r\n    if (rpc_url) {\r\n      // i\r\n      if (rpc_url.charAt(rpc_url.length - 1) === '/')\r\n        rpc_url = rpc_url.substr(0, rpc_url.length - 1)\r\n      strapi.log.info('conf server url:', rpc_url)\r\n\r\n      // setInterval(async () => {\r\n        // heart polling\r\n        // get active conf\r\n        await request(\r\n          rpc_url + '/srv/dm-plugin/get',\r\n          async (err: any, res: any, body: any) => {\r\n            strapi.log.debug('[ping]', rpc_url + '/srv/dm-plugin/get')\r\n            if (this.douyin_pk_conf) {\r\n              const data = JSON.parse(body)\r\n              await this.update_conf(data)\r\n              await this.compare_stat_upload(data, rpc_url)\r\n            }\r\n          }\r\n        ) // request\r\n      // }, 3000)\r\n\r\n      var socket = require('socket.io-client')(rpc_url + '/dm')\r\n      socket.on('connect', function () {\r\n        strapi.log.info('init ws conf', rpc_url)\r\n      })\r\n      socket.on('DM_EVENT_GET_LAST_DM', async (data: any) => {\r\n        if (Number(data['amount']) > 0) {\r\n          let dm_arr = await this.find_lottery_user(data['amount'], 0, [])\r\n          strapi_.log.info('douyinStatSrv dm_arr', dm_arr.length)\r\n          // rpc_url\r\n          await post_data(rpc_url + '/srv/dm-plugin/last-dm/', { dm_arr })\r\n        }\r\n      })\r\n      socket.on('test', function () {\r\n        strapi_.log.info('test ws')\r\n      })\r\n      socket.on('DM_EVENT_NEW_CONF', async (data: any) => {\r\n        // receive new conf \r\n        strapi_.log.info('DM_EVENT_NEW_CONF')\r\n        await this.update_conf(data)\r\n        await this.compare_stat_upload(data, rpc_url)\r\n      })\r\n      socket.on('disconnect', function () { })\r\n    }\r\n  }\r\n  async find_lottery_user(amount: number, start: number, $dm_arr: Array<any>) {\r\n    const find_dm = (page: any, dm_arr: Array<any>) => {\r\n      const { data } = page\r\n      if (data && data['dm_arr'] && data['dm_arr'].length) {\r\n        strapi_.log.info('find_lottery_user concat:', data['dm_arr'].length)\r\n        // return dm_arr.concat(data['dm_arr'])\r\n        for (let i = 0; i < data['dm_arr'].length; i++) {\r\n          const dm = data['dm_arr'][i]\r\n          dm_arr.push(dm)\r\n        }\r\n      }\r\n    }\r\n    let find_from = this.douyin_pk_conf['stat_from']\r\n    let dm_pages = await strapi\r\n      .query('dm-page')\r\n      .find({\r\n        created_at_gt: find_from,\r\n        _start: start,\r\n        _sort: 'created_at:desc'\r\n      })\r\n    for (let page of dm_pages) {\r\n      if ($dm_arr.length < amount) find_dm(page, $dm_arr)\r\n      else break\r\n    }\r\n    strapi_.log.info('find_lottery_user need:', amount, 'find', $dm_arr.length)\r\n    if (dm_pages.length === 100 && $dm_arr.length < amount) {\r\n      await this.find_lottery_user(amount, start + 100, $dm_arr)\r\n    }\r\n    return $dm_arr\r\n  }\r\n  async update_conf(data: any) {\r\n    strapi.log.info('update active conf')\r\n    if (\r\n      data &&\r\n      this.douyin_pk_conf['conf_updated_at'] !==\r\n      data['option_conf']['conf_updated_at']\r\n    ) {\r\n      if (data['option_conf']) {\r\n        this.douyin_pk_conf['data']['option_arr'] =\r\n          data['option_conf']['option_arr']\r\n      }\r\n      this.douyin_pk_conf['stat_from'] = data['option_conf']['stat_from']\r\n      this.douyin_pk_conf['conf_updated_at'] =\r\n        data['option_conf']['conf_updated_at']\r\n      await strapi\r\n        .query('plugin-conf')\r\n        .update({ id: this.douyin_pk_conf['id'] }, this.douyin_pk_conf)\r\n      strapi.log.info('update active cond', this.douyin_pk_conf['data'])\r\n      this.boot()\r\n    }\r\n  }\r\n  async compare_stat_upload(data: any, url: string) {\r\n    // compare count\r\n    let option_arr = this.douyin_pk_conf['data']['option_arr']\r\n    let remote_option_arr = data['option_conf']['option_arr']\r\n    if (option_arr) {\r\n      let is_new_stat = false\r\n\r\n      // strapi.log.info('remote:', remote_option_arr)\r\n      for (let remote_option of remote_option_arr) {\r\n        let query = remote_option['query']\r\n        if (this.stat_pk[query] !== remote_option['count']) {\r\n          is_new_stat = true\r\n          remote_option['count'] = this.stat_pk[query]\r\n        }\r\n      }\r\n\r\n      if (is_new_stat) {\r\n        strapi.log.info('new stat', this.stat_pk)\r\n        await post_data(url + '/srv/dm-plugin/stat', {\r\n          option_conf: { option_arr: remote_option_arr }\r\n        })\r\n        // await request(\r\n        //     {\r\n        //         url: url + '/srv/dm-plugin/stat',\r\n        //         method: 'POST',\r\n        //         json: true,\r\n        //         headers: {\r\n        //             'content-type': 'application/json'\r\n        //         },\r\n        //         body: { option_conf: { option_arr: remote_option_arr } }\r\n        //     },\r\n        //     function (error: any, response: any, body: any) {\r\n        //         if (!error && response.statusCode == 200) {\r\n        //         }\r\n        //     }\r\n        // )\r\n      }\r\n    }\r\n  }\r\n  async calc_pk(start = 0) {\r\n    const [entry] = (await strapi\r\n      .query('plugin-conf')\r\n      .find({ name: 'douyin-pk' })) as Array<Idoc_plugin_conf>\r\n\r\n    if (entry) {\r\n      let find_from = entry['stat_from']\r\n      let dm_pages = await strapi\r\n        .query('dm-page')\r\n        .find({ created_at_gt: find_from, _start: start })\r\n      if (dm_pages.length) {\r\n        strapi.log.info('active conf option_arr')\r\n        for (let option of this.douyin_pk_conf['data']['option_arr']) {\r\n          strapi.log.info('--option', option)\r\n        }\r\n        for (let page of dm_pages) {\r\n          this.calc_page(page)\r\n        }\r\n        // this.stat_pk = stat_pk;\r\n        strapi.log.info(':::stat_from', find_from, 'start', start)\r\n        strapi.log.info(':::dm-pages count:', dm_pages.length)\r\n        strapi.log.info(':::stat_', this.stat_pk)\r\n        // strapi.log.info(\":::stat_\", this.stat_pk);\r\n        if (dm_pages.length === 100) {\r\n          this.calc_pk(start + 100)\r\n        }\r\n      } else {\r\n        strapi.log.info('stat_pk', 'no dm-page from', find_from)\r\n      }\r\n    }\r\n  }\r\n  async calc_page(page: any) {\r\n    const find_query = function (text: any, pk_conf: any, stat_pk: any) {\r\n      for (let option of pk_conf['data']['option_arr']) {\r\n        const { query } = option\r\n        if (!stat_pk[query]) stat_pk[query] = 0\r\n        if (query && text.includes(query)) {\r\n          stat_pk[query]++\r\n          // strapi.log.info(\"calc_pk\", query, stat_pk[query]);\r\n        }\r\n      }\r\n    }\r\n    const { data } = page\r\n    if (data && data['dm_arr']) {\r\n      for (let dm of data['dm_arr']) {\r\n        //   strapi.log.info(\"calc_pk\", dm);\r\n        const { text } = dm\r\n        find_query(text, this.douyin_pk_conf, this.stat_pk)\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { strapi_ } from '../../strapi'\r\nimport { DouyinStat } from './dm-page-stat'\r\nconst strapi = strapi_\r\nconst douyinStatSrv = new DouyinStat()\r\nsetTimeout(async () => {\r\n  await douyinStatSrv.boot()\r\n  let dm_arr = await douyinStatSrv.find_lottery_user(100, 0, [])\r\n  strapi_.log.info('douyinStatSrv dm_arr', dm_arr.length)\r\n}, 2000)\r\nexport const PLUG_POST_dm_page = async (ctx: any) => {\r\n  // post new dmk_list from airtest\r\n  const { dmk_list } = ctx.request.body as any\r\n  strapi.log.info('PLUG_POST_dm_page', dmk_list.length)\r\n\r\n  let new_dm_arr = []\r\n  if (dmk_list && dmk_list.length > 0) {\r\n    strapi.log.info('receive from airtest<==dmk_list:', dmk_list.length)\r\n    for (let dmk of dmk_list) {\r\n      let a = dmk.split('：')\r\n      if (a.length > 1) {\r\n        let username = a.shift()\r\n        let text = a.join('：')\r\n        strapi.log.info(`::${username}: `, text)\r\n        new_dm_arr.push({ username, text })\r\n      }\r\n    }\r\n  }\r\n  let entry: any\r\n  if (new_dm_arr.length) {\r\n    // let timestamp_sec = Math.floor(new Date().getTime() / 1000);\r\n    let new_page = {\r\n      data: { dm_arr: new_dm_arr }\r\n    }\r\n    entry = await strapi.query('dm-page').create(new_page)\r\n    let created_at = entry['created_at'] as any\r\n    strapi.log.info('new dm-page created_at', created_at)\r\n    douyinStatSrv.calc_page(new_page)\r\n    strapi.log.info('stat_pk', douyinStatSrv.stat_pk)\r\n  }\r\n  // Send 200 `ok`\r\n  ctx.send({\r\n    message: 'ok',\r\n    create_count: new_dm_arr.length\r\n  })\r\n}\r\nexport const PLUG_POST_update_conf = async (ctx: any) => {\r\n  await douyinStatSrv.boot()\r\n  ctx.send({\r\n    message: 'ok',\r\n    stat: douyinStatSrv.stat_pk,\r\n    conf: douyinStatSrv.douyin_pk_conf['data'] as any\r\n  })\r\n}\r\nexport const PLUG_GET_dm_page = async (ctx: any) => {\r\n  strapi.log.info('dm stat start')\r\n  // Send 200 `ok`\r\n  ctx.send({\r\n    message: 'ok',\r\n    stat: douyinStatSrv.stat_pk,\r\n    conf: douyinStatSrv.douyin_pk_conf['data'] as any\r\n  })\r\n}\r\n","import {\r\n  PLUG_GET_dm_page,\r\n  PLUG_POST_dm_page\r\n} from './plugins/dm-page.plugin/dm-page'\r\n//┌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┐\r\n//╎                plugin routes\r\n//╎\r\n//╎\r\n//└╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┘\r\n\r\nconst POST_plugins: any = {\r\n  boot: PLUG_POST_dm_page,\r\n  'dm-page': PLUG_POST_dm_page\r\n}\r\nconst GET_plugins: any = {\r\n  // /srv/dm-page/get\r\n  'dm-page': PLUG_GET_dm_page\r\n}\r\n//┌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┐\r\n//╎                 strapi handler\r\n//╎\r\n//╎\r\n//└╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┘\r\nmodule.exports = {\r\n  index: async (ctx: any) => {\r\n    const { plugin_name } = ctx.params\r\n    await handle(GET_plugins, plugin_name, ctx)\r\n  },\r\n  index_post: async (ctx: any) => {\r\n    const { plugin_name } = ctx.params\r\n    await handle(POST_plugins, plugin_name, ctx)\r\n  }\r\n}\r\n//┌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┐\r\n//╎                  handler\r\n//╎\r\n//╎\r\n//└╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┘\r\nconst handle = async (plugin_routes: any, plugin_name: string, ctx: any) => {\r\n  const func = plugin_routes[plugin_name]\r\n  if (func) await func(ctx)\r\n  else\r\n    ctx.send({\r\n      msg: 'no plugin',\r\n      plugin_name\r\n    })\r\n}\r\n"],"names":["strapi"],"mappings":"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"}